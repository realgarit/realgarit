name: Connect4

on:
  workflow_dispatch:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  play:
    runs-on: ubuntu-latest
    if: startsWith(github.event.issue.title, 'connect4|')
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: pip install Pillow

      - name: Setup Connect4 Branch
        run: |
          # Configure git first
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Check if connect4 branch exists, create if it doesn't
          if ! git ls-remote --heads origin connect4 | grep -q connect4; then
            git checkout --orphan connect4
            git rm -rf . || true
            git commit --allow-empty -m "Initial commit for Connect4 branch"
            git push origin connect4
          fi

      - name: Checkout Connect4 Branch
        uses: actions/checkout@v3
        with:
          ref: connect4
          path: output_branch

      - name: Run Game Logic
        id: game
        run: |
          # Extract Move from Title (format: connect4|drop|NUM)
          TITLE="${{ github.event.issue.title }}"
          MOVE=$(echo $TITLE | cut -d'|' -f3)
          
          # Copy script from main checkout to output_branch
          # The main checkout is at workspace root, output_branch is a subdirectory
          cp "${{ github.workspace }}/.github/scripts/connect4.py" "${{ github.workspace }}/output_branch/"
          
          cd output_branch
          
          # Run the script
          export MOVE_COL=$MOVE
          export ACTOR="${{ github.actor }}"
          python connect4.py
          
          # Remove script before committing
          rm connect4.py
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Commit changes
          git add connect4.png connect4_state.txt
          git commit -m "Move played by ${{ github.actor }}" || echo "No changes to commit"
          git push origin connect4

      - name: Close Issue
        uses: peter-evans/close-issue@v3
        with:
          issue-number: ${{ github.event.issue.number }}
          comment: "Move processed! Board updated. ðŸ”´ðŸŸ¡"
